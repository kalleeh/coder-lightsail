# Coder Deployment

A self-hosted [Coder](https://coder.com/) deployment with automatic HTTPS, PostgreSQL,
Docker workspaces, and an optional AI coding assistant (Claude Code via AWS Bedrock).

## Architecture

```
Internet -> DNS (A record) -> Caddy (HTTPS, port 443)
                                  |
                           Coder Server (localhost:7080)
                              /          \
                      PostgreSQL      Docker Workspaces
                      (persistent)    (per-user)
```

Coder listens on port 7080 bound to localhost only. All external traffic goes through
Caddy's HTTPS reverse proxy.

The **agent-shell** workspace template provides:

- **Browser terminal** -- ttyd + tmux accessible from any browser
- **Mobile terminal** -- touch-friendly keybar for iOS/iPadOS
- **Claude Code CLI** -- AI coding assistant via AWS Bedrock
- **Developer tools** -- zsh, Starship, fzf, zoxide, Node.js, Kiro CLI

## Quick Start

```bash
cp .env.example .env
nano .env              # set DOMAIN and CODER_ACCESS_URL at minimum
sudo bash setup.sh
```

The setup script is idempotent (safe to re-run). It will install Docker, Caddy,
configure the firewall, and start the stack.

Then open `https://your-domain.com`, create your admin account, and push the template:

```bash
coder login https://your-domain.com
coder templates push agent-shell --directory ./agent-shell
```

## Configuration

All configuration lives in `.env`. See `.env.example` for annotated defaults.

| Variable | Required | Description |
|---|---|---|
| `DOMAIN` | Yes | Domain name pointing to this server |
| `CODER_ACCESS_URL` | Yes | Full URL (e.g. `https://coder.example.com`) |
| `POSTGRES_PASSWORD` | No | Auto-generated by setup.sh if not set |
| `AWS_REGION` | No | AWS region for Bedrock (default: `us-east-1`) |
| `DOCKER_GID` | No | Auto-detected by setup.sh |
| `CODER_VERSION` | No | Coder image tag (default: `latest`) |

## Troubleshooting

**HTTPS/certificate errors** -- Verify DNS points to the server IP (`dig your-domain.com`).
Ensure ports 80 and 443 are open in your cloud provider's firewall. Check `journalctl -u caddy -f`.

**502 Bad Gateway** -- Coder may still be starting. Wait 30-60 seconds. Check `docker compose logs coder`.

**Workspace agent unhealthy** -- Check logs in the Coder dashboard. Verify DOCKER_GID in `.env`
matches the host: `getent group docker | cut -d: -f3`.

## Backup and Restore

```bash
# Backup
docker compose exec -T database pg_dump -U coder coder | gzip > backup-$(date +%Y%m%d).sql.gz

# Restore
gunzip -c backup-YYYYMMDD.sql.gz | docker compose exec -T database psql -U coder coder
```

## Useful Commands

```bash
docker compose logs -f          # View logs
docker compose restart          # Restart stack
docker compose down             # Stop stack
journalctl -u caddy -f          # Caddy logs
sudo bash setup.sh              # Re-run setup (idempotent)
```

## License

[MIT](../LICENSE)
